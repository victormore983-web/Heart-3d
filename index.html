<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOVE_VIC_ZAFIRO</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Times New Roman', serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        h1 { color: #fceea7; font-size: 50px; margin: 0; letter-spacing: 5px; text-shadow: 0 0 30px rgba(252,238,167,0.8); }
        .controls { display: flex; gap: 10px; pointer-events: auto; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        .btn { background: rgba(0,0,0,0.8); border: 1px solid #d4af37; color: #d4af37; padding: 10px 20px; cursor: pointer; text-transform: uppercase; font-size: 11px; border-radius: 4px; transition: 0.3s; }
        .btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 15px #d4af37; }
        input[type="file"] { display: none; }
        .status { color: #d4af37; font-size: 10px; margin-top: 15px; letter-spacing: 2px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="ui-layer">
        <h1>VICðŸ‘¿PERSI</h1>
        <div class="controls">
            <label class="btn">1. Elegir Fotos<input type="file" id="file-input" multiple accept="image/*"></label>
            <label class="btn">2. Cargar "Dime.mp3"<input type="file" id="music-input" accept="audio/*"></label>
            <button class="btn" id="play-btn" style="display:none;">Reproducir</button>
        </div>
        <div class="status" id="status-text">ESPERANDO MANO...</div>
    </div>
    
    <video id="webcam" autoplay playsinline style="display:none;"></video>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm';

        let scene, camera, renderer, composer, mainGroup, clock = new THREE.Clock();
        let particles = [], handLandmarker, video, state = { mode: 'TREE' };
        let photoTextures = [], starField;
        let audio, audioListener, isPlaying = false;

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 75;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Bloom Effect (Brillo mÃ¡gico)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.25;
            bloomPass.strength = 0.7; 
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            mainGroup = new THREE.Group();
            scene.add(mainGroup);

            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            createStars();
            createHeart();
            
            // Listeners
            document.getElementById('file-input').addEventListener('change', handlePhotos);
            document.getElementById('music-input').addEventListener('change', handleMusic);
            document.getElementById('play-btn').addEventListener('click', togglePlay);

            await initHandTracking();
            animate();
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<4000; i++) {
                pos.push((Math.random()-0.5)*500, (Math.random()-0.5)*500, (Math.random()-0.5)*500);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            starField = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.4 }));
            scene.add(starField);
        }

        function createHeart() {
            const planeGeo = new THREE.PlaneGeometry(1.3, 1.3);
            for (let i = 0; i < 1200; i++) {
                const isGold = Math.random() > 0.4;
                const mat = new THREE.MeshStandardMaterial({ 
                    color: isGold ? 0xfceea7 : 0xff3333,
                    side: THREE.DoubleSide,
                    transparent: true,
                    emissive: isGold ? 0x332200 : 0x220000
                });
                const mesh = new THREE.Mesh(planeGeo, mat);
                mainGroup.add(mesh);
                particles.push(new Particle(mesh, isGold));
            }
        }

        class Particle {
            constructor(mesh, isGold) {
                this.mesh = mesh;
                this.isGold = isGold;
                this.isPhoto = false;
                this.posHeart = new THREE.Vector3();
                this.posExplode = new THREE.Vector3();

                const t = Math.random() * Math.PI * 2;
                const r = Math.pow(Math.random(), 0.6);
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                
                this.posHeart.set(x * r, y * r, (Math.random()-0.5)*10);
                this.posExplode.set((Math.random()-0.5)*200, (Math.random()-0.5)*150, (Math.random()-0.5)*150);
            }

            update(dt, mode) {
                const target = (mode === 'TREE') ? this.posHeart : this.posExplode;
                this.mesh.position.lerp(target, 2.2 * dt);
                
                if (mode === 'EXPLODE') {
                    this.mesh.rotation.x += 1 * dt;
                    this.mesh.rotation.y += 1 * dt;
                    if (this.isPhoto) this.mesh.scale.lerp(new THREE.Vector3(8, 8, 8), 4 * dt);
                } else {
                    this.mesh.rotation.y += 0.4 * dt;
                    this.mesh.scale.lerp(new THREE.Vector3(1, 1, 1), 4 * dt);
                }
            }
        }

        function handlePhotos(e) {
            const loader = new THREE.TextureLoader();
            Array.from(e.target.files).forEach((file, i) => {
                const url = URL.createObjectURL(file);
                loader.load(url, tex => {
                    photoTextures.push(tex);
                    applyTextures();
                });
            });
        }

        function applyTextures() {
            particles.forEach((p, i) => {
                if (photoTextures.length > 0 && Math.random() > 0.6) {
                    p.mesh.material.map = photoTextures[i % photoTextures.length];
                    p.mesh.material.color.set(0xffffff);
                    p.isPhoto = true;
                    p.mesh.material.needsUpdate = true;
                }
            });
        }

        function handleMusic(e) {
            if (!audioListener) {
                audioListener = new THREE.AudioListener();
                camera.add(audioListener);
                audio = new THREE.Audio(audioListener);
            }
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            const loader = new THREE.AudioLoader();
            loader.load(url, buffer => {
                audio.setBuffer(buffer);
                audio.setLoop(true);
                audio.setVolume(0.6);
                document.getElementById('play-btn').style.display = 'block';
                document.getElementById('status-text').innerText = "ðŸŽµ MÃšSICA LISTA";
            });
        }

        function togglePlay() {
            if (!isPlaying) { audio.play(); isPlaying = true; this.innerText = "Pausar"; }
            else { audio.pause(); isPlaying = false; this.innerText = "Reproducir"; }
        }

        async function initHandTracking() {
            video = document.getElementById('webcam');
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if (handLandmarker && video.readyState >= 2) {
                const results = handLandmarker.detectForVideo(video, performance.now());
                if (results.landmarks && results.landmarks[0]) {
                    const lm = results.landmarks[0];
                    const d = Math.hypot(lm[8].x - lm[0].x, lm[8].y - lm[0].y);
                    state.mode = (d < 0.35) ? 'TREE' : 'EXPLODE';
                    document.getElementById('status-text').innerText = (state.mode === 'TREE') ? "â¤ CORAZÃ“N UNIDO" : "âœ¨ EXPLOSIÃ“N: DIME...";
                }
            }

            starField.rotation.y += 0.06 * dt;
            mainGroup.rotation.y += 0.1 * dt;
            particles.forEach(p => p.update(dt, state.mode));
            composer.render();
        }
        init();
    </script>
</body>
</html>